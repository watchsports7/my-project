{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load tz %}
{% load l10n %}

{% block content %}
<div class="container py-4">
  <div class="row g-4">

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="col-lg-8">
      <div class="card shadow-sm border-0 rounded-4 p-4 mb-4">

        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <h1 class="fw-bold mb-3 text-center">{{ article.title }}</h1>

        <!-- –ò–Ω—Ñ–æ-–±–ª–æ–∫ -->
        <div class="d-flex flex-wrap justify-content-center align-items-center text-muted mb-3" style="gap: 1rem;">
          <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
          <span class="badge bg-primary px-3 py-2">
            <i class="bi bi-tag"></i> {{ article.category.title }}
          </span>

          <!-- –î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ -->
          <span>
            <i class="bi bi-calendar3"></i>
            {{ article.pub_date|localtime|date:"d E Y, H:i" }}
          </span>

          <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ -->
          <span>
            <i class="bi bi-eye"></i> {{ article.views }}
          </span>

          <!-- –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤) -->
          {% if user.is_staff %}
          <a href="{% url 'admin:news_article_change' article.id %}" class="btn btn-outline-secondary btn-sm ms-2">
            <i class="bi bi-pencil-square"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
          </a>
          {% endif %}
        </div>

        <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
        {% if article.image %}
        <img src="{{ article.image.url }}" class="img-fluid rounded-4 mb-4 shadow-sm" alt="{{ article.title }}">
        {% elif article.image_url %}
        <img src="{{ article.image_url }}" class="img-fluid rounded-4 mb-4 shadow-sm" alt="{{ article.title }}">
        {% endif %}

        <!-- –ê–Ω–æ–Ω—Å -->
        {% if article.anons %}
        <p class="lead text-center fw-semibold">{{ article.anons }}</p>
        {% endif %}

        <hr class="my-4">

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç -->
        <div class="article-content fs-5 lh-lg mb-4">
          {{ article.content|safe }}
        </div>

        <!-- üîπ –ë–ª–æ–∫ –ª–∞–π–∫–æ–≤ –∏ –¥–∏–∑–ª–∞–π–∫–æ–≤ -->
        <div class="d-flex justify-content-center align-items-center gap-4 mt-4" id="reaction-container">
          <button id="like-btn"
                  class="btn btn-outline-success d-flex align-items-center gap-2 px-3 py-2 rounded-pill fw-semibold shadow-sm {% if user_reaction and user_reaction.is_like %}active{% endif %}">
            <i class="bi bi-hand-thumbs-up-fill"></i>
            <span id="likes-count">{{ likes_count }}</span>
          </button>

          <button id="dislike-btn"
                  class="btn btn-outline-danger d-flex align-items-center gap-2 px-3 py-2 rounded-pill fw-semibold shadow-sm {% if user_reaction and not user_reaction.is_like %}active{% endif %}">
            <i class="bi bi-hand-thumbs-down-fill"></i>
            <span id="dislikes-count">{{ dislikes_count }}</span>
          </button>
        </div>

      </div>
    </div>

    <!-- –ë–æ–∫–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ü–æ—Ö–æ–∂–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm rounded-4 p-3">
        <h5 class="fw-bold mb-3 text-center border-bottom pb-2">
          –ù–æ–≤–æ—Å—Ç–∏ {{ article.category.title }}
        </h5>

        {% for related in related_articles %}
        <div class="d-flex align-items-center mb-3">
          {% if related.image %}
          <img src="{{ related.image.url }}" class="rounded me-3" style="width: 70px; height: 70px; object-fit: cover;" alt="{{ related.title }}">
          {% elif related.image_url %}
          <img src="{{ related.image_url }}" class="rounded me-3" style="width: 70px; height: 70px; object-fit: cover;" alt="{{ related.title }}">
          {% endif %}
          <div>
            <a href="{% url 'news:article_detail' related.slug %}" class="fw-semibold text-decoration-none text-dark small d-block">
              {{ related.title|truncatechars:70 }}
            </a>
            <small class="text-muted">
              <i class="bi bi-calendar"></i> {{ related.pub_date|localtime|date:"d.m.Y" }}
            </small>
          </div>
        </div>
        {% empty %}
        <p class="text-muted text-center">–ù–µ—Ç –¥—Ä—É–≥–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.</p>
        {% endfor %}

        <div class="text-center mt-3">
          <a href="{% url 'news:category_detail' article.category.slug %}" class="btn btn-category-all">
            <i class="bi bi-collection"></i> –í—Å–µ –Ω–æ–≤–æ—Å—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
          </a>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<!-- –°—Ç–∏–ª–∏ -->
<style>
.btn-category-all {
  background-color: #0d6efd;
  color: white;
  border: none;
  padding: 8px 20px;
  border-radius: 50px;
  font-weight: 600;
  box-shadow: 0 0 8px rgba(13, 110, 253, 0.3);
  transition: all 0.3s ease;
}
.btn-category-all:hover {
  background-color: #0b5ed7;
  transform: scale(1.06);
  box-shadow: 0 0 15px rgba(13, 110, 253, 0.6);
  color: #fff;
}

/* –õ–∞–π–∫–∏ / –¥–∏–∑–ª–∞–π–∫–∏ */
#reaction-container button {
  font-size: 1.05rem;
  transition: all 0.2s ease;
}
#reaction-container button.active {
  background-color: #198754 !important;
  color: white;
}
#reaction-container button.btn-outline-danger.active {
  background-color: #dc3545 !important;
}
#reaction-container button:hover {
  transform: scale(1.05);
}
</style>

<!-- AJAX —Å–∫—Ä–∏–ø—Ç -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const likeBtn = document.getElementById('like-btn');
  const dislikeBtn = document.getElementById('dislike-btn');
  const likesCount = document.getElementById('likes-count');
  const dislikesCount = document.getElementById('dislikes-count');

  function sendReaction(action) {
    fetch("{% url 'news:react_article' article.slug %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "X-Requested-With": "XMLHttpRequest",
      },
      body: new URLSearchParams({action: action})
    })
    .then(res => res.json())
    .then(data => {
      if (data.likes !== undefined) {
        likesCount.textContent = data.likes;
        dislikesCount.textContent = data.dislikes;
        likeBtn.classList.toggle('active', action === 'like');
        dislikeBtn.classList.toggle('active', action === 'dislike');
      }
    });
  }

  likeBtn.addEventListener('click', () => sendReaction('like'));
  dislikeBtn.addEventListener('click', () => sendReaction('dislike'));
});
</script>
{% endblock %}
